rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && getUserRole() == role;
    }
    
    // Helper function to check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserRole() in roles;
    }
    
    // Public read access for website content
    match /website_content/{document} {
      allow read: if true; // Public content
      allow write: if hasAnyRole(['admin', 'manager']);
    }
    
    // Customer inquiries - public can create, staff can manage
    match /inquiries/{document} {
      allow create: if true; // Allow public form submissions
      allow read, update, delete: if hasAnyRole(['admin', 'manager', 'technician']);
    }
    
    // Quotes - staff only
    match /quotes/{document} {
      allow read, write: if hasAnyRole(['admin', 'manager', 'technician']);
    }
    
    // Projects tracking - staff only
    match /projects/{document} {
      allow read, write: if hasAnyRole(['admin', 'manager', 'technician']);
    }
    
    // User profiles
    match /users/{userId} {
      allow read, write: if isAuthenticated() && 
        (request.auth.uid == userId || hasRole('admin'));
      
      // Only admins can create new user documents
      allow create: if hasRole('admin');
    }
    
    // Company settings - admin only
    match /settings/{document} {
      allow read: if hasAnyRole(['admin', 'manager']);
      allow write: if hasRole('admin');
    }
    
    // Analytics and logs - admin/manager only
    match /analytics/{document} {
      allow read, write: if hasAnyRole(['admin', 'manager']);
    }
    
    // Error logs - system generated, admin read only
    match /error_logs/{document} {
      allow read: if hasRole('admin');
      allow create: if true; // Allow system to create error logs
    }
    
    // Testimonials - public read, staff write
    match /testimonials/{document} {
      allow read: if true;
      allow write: if hasAnyRole(['admin', 'manager']);
    }
    
    // Contact form submissions
    match /contact_submissions/{document} {
      allow create: if true; // Public can submit
      allow read, update: if hasAnyRole(['admin', 'manager']);
    }
    
    // File uploads metadata
    match /uploads/{document} {
      allow read, write: if hasAnyRole(['admin', 'manager', 'technician']);
    }
    
    // Scheduled tasks and jobs
    match /scheduled_tasks/{document} {
      allow read, write: if hasAnyRole(['admin', 'manager']);
    }
    
    // Notifications
    match /notifications/{userId}/{document} {
      allow read, write: if isAuthenticated() && 
        (request.auth.uid == userId || hasRole('admin'));
    }
    
    // Default deny rule for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}